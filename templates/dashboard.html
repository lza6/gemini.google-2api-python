<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini é€†å‘ API æ§åˆ¶å°</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .api-box { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9rem; position: relative; }
        .copy-btn { position: absolute; right: 10px; top: 10px; font-size: 0.8rem; padding: 2px 8px; }
        .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-active { background-color: #00b894; box-shadow: 0 0 5px #00b894; }
        .status-inactive { background-color: #d63031; }
        .loading-spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1200px;">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-primary mb-0">ğŸ¤– Gemini é€†å‘ API æ§åˆ¶å°</h2>
                <small class="text-muted">æœ¬åœ°é«˜æ€§èƒ½ä»£ç†æœåŠ¡ â€¢ æ— éœ€ Docker</small>
            </div>
            <span class="badge bg-info text-dark">å½“å‰ä»£ç†: {{ proxy }}</span>
        </header>

        <div class="row">
            <div class="col-lg-4">
                
                <div class="card p-3 border-primary border-2">
                    <h5 class="card-title text-primary fw-bold mb-3">ğŸš€ API è¿æ¥é…ç½®</h5>
                    <p class="small text-muted mb-2">è¯·å°†ä»¥ä¸‹ä¿¡æ¯å¡«å…¥ NextChat / ChatBox ç­‰è½¯ä»¶ï¼š</p>
                    
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">æ¥å£åœ°å€ (Base URL):</label>
                        <div class="api-box">
                            {{ api_url }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="small fw-bold text-muted">API Key (å¯†é’¥):</label>
                        <div class="api-box">
                            sk-any-key (ä»»æ„å¡«å†™)
                        </div>
                    </div>

                    <div class="mb-1">
                        <label class="small fw-bold text-muted">æ¨èæ¨¡å‹åç§°:</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge bg-secondary">gemini-2.5-pro</span>
                            <span class="badge bg-secondary">gemini-2.5-flash</span>
                            <span class="badge bg-secondary">gemini-pro</span>
                        </div>
                    </div>
                </div>

                <!-- è‡ªåŠ¨æå–åŠŸèƒ½ -->
                <div class="card p-3 mb-3">
                    <h5 class="card-title mb-3">ğŸ”® æ™ºèƒ½æå– Cookie</h5>
                    <p class="small text-muted mb-2">
                        <strong>æ”¯æŒæ ¼å¼ï¼š</strong>HARæ–‡ä»¶ã€ç½‘ç»œè¯·æ±‚å¤´ã€cURLå‘½ä»¤<br>
                        <strong>è·å–æ–¹æ³•ï¼š</strong>F12 â†’ Network â†’ æ‰¾åˆ° StreamGenerate â†’ å³é”® â†’ Copy â†’ Copy as HAR
                    </p>
                    
                    <div class="mb-2">
                        <label class="small text-muted">ç²˜è´´ HAR/è¯·æ±‚å†…å®¹ï¼š</label>
                        <textarea id="harContent" class="form-control" rows="4" placeholder="ç²˜è´´ HAR æ–‡ä»¶å†…å®¹æˆ–ç½‘ç»œè¯·æ±‚ä¿¡æ¯..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-info" onclick="extractCookies()">
                            ğŸ“¡ è‡ªåŠ¨æå– Cookie
                        </button>
                    </div>
                    
                    <!-- æå–ç»“æœæ˜¾ç¤º -->
                    <div id="extractResult" class="mt-3" style="display: none;">
                        <div class="alert alert-info" role="alert">
                            <h6 class="alert-heading">ğŸ“Š æå–æ—¥å¿—</h6>
                            <pre id="extractLogs" class="mb-0 small" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></pre>
                        </div>
                        
                        <div id="extractedCookiesSection" style="display: none;">
                            <h6 class="small text-muted mb-2">æå–åˆ°çš„ Cookieï¼š</h6>
                            <div id="extractedCookiesList" class="small mb-2"></div>
                            
                            <div class="input-group mb-2">
                                <input type="text" id="extractedAccountName" class="form-control" placeholder="è´¦å·å¤‡æ³¨å">
                                <button class="btn btn-success" type="button" onclick="autoAddAccount()">
                                    â• æ·»åŠ åˆ°è´¦å·æ± 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨æ·»åŠ åŠŸèƒ½ -->
                <div class="card p-3">
                    <h5 class="card-title mb-3">â• æ‰‹åŠ¨æ·»åŠ  Gemini è´¦å·</h5>
                    <form action="/account/add" method="post">
                        <div class="mb-2">
                            <label class="small text-muted">å¤‡æ³¨å</label>
                            <input type="text" class="form-control" name="name" placeholder="ä¾‹å¦‚: è°·æ­Œä¸»å·" required>
                        </div>
                        <div class="mb-2">
                            <label class="small text-muted">Cookie: __Secure-1PSID</label>
                            <input type="text" class="form-control" name="p1" placeholder="ä»æµè§ˆå™¨ F12 è·å–" required>
                        </div>
                        <div class="mb-3">
                            <label class="small text-muted">Cookie: __Secure-1PSIDTS</label>
                            <input type="text" class="form-control" name="p2" placeholder="ä»æµè§ˆå™¨ F12 è·å–" required>
                        </div>
                        <button type="submit" class="btn btn-dark w-100">ç¡®è®¤æ·»åŠ </button>
                    </form>
                </div>
            </div>

            <div class="col-lg-8">
                
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">ğŸ‘¥ è´¦å·è´Ÿè½½å‡è¡¡æ± </h5>
                        <span class="badge bg-light text-dark border">å…± {{ accounts|length }} ä¸ªè´¦å·</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>Cookieé¢„è§ˆ</th>
                                    <th>ç´¯è®¡è°ƒç”¨</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if not accounts %}
                                <tr><td colspan="5" class="text-center text-muted py-4">æš‚æ— è´¦å·ï¼Œè¯·åœ¨å·¦ä¾§æ·»åŠ </td></tr>
                                {% endif %}
                                {% for acc in accounts %}
                                <tr>
                                    <td>
                                        {% if acc.is_active %}
                                        <span class="status-dot status-active"></span><span class="small text-success">å¯ç”¨</span>
                                        {% else %}
                                        <span class="status-dot status-inactive"></span><span class="small text-danger">ç¦ç”¨</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold">{{ acc.name }}</td>
                                    <td class="small text-muted" style="font-family: monospace;">{{ acc.cookie_1psid[:8] }}...</td>
                                    <td><span class="badge bg-primary rounded-pill">{{ acc.total_calls }}</span></td>
                                    <td>
                                        <a href="/account/toggle/{{ acc.id }}" class="btn btn-sm btn-outline-secondary py-0">åˆ‡æ¢</a>
                                        <a href="/account/delete/{{ acc.id }}" class="btn btn-sm btn-outline-danger py-0">åˆ é™¤</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title m-0">ğŸ“Š å®æ—¶è°ƒç”¨æ—¥å¿—</h5>
                        <a href="/logs/clear" class="btn btn-sm btn-light border">æ¸…ç©ºæ—¥å¿—</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead><tr><th>æ—¶é—´</th><th>æ‰§è¡Œè´¦å·</th><th>æ¨¡å‹</th><th>è€—æ—¶</th><th>çŠ¶æ€</th></tr></thead>
                            <tbody>
                                {% if not logs %}
                                <tr><td colspan="5" class="text-center text-muted py-3">æš‚æ— è°ƒç”¨è®°å½•</td></tr>
                                {% endif %}
                                {% for log in logs %}
                                <tr>
                                    <td class="small">{{ log.timestamp.split(' ')[1] }}</td>
                                    <td class="small">{{ log.account_name }}</td>
                                    <td><span class="badge bg-secondary" style="font-size: 0.7rem">{{ log.model }}</span></td>
                                    <td class="small">{{ log.duration }}ms</td>
                                    <td>
                                        {% if log.status == 'SUCCESS' %}
                                        <span class="badge bg-success">æˆåŠŸ</span>
                                        {% else %}
                                        <span class="badge bg-danger">å¤±è´¥</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let extractedData = null;

        async function extractCookies() {
            const harContent = document.getElementById('harContent').value.trim();
            const resultDiv = document.getElementById('extractResult');
            const logsPre = document.getElementById('extractLogs');
            const cookiesSection = document.getElementById('extractedCookiesSection');
            const cookiesList = document.getElementById('extractedCookiesList');
            
            if (!harContent) {
                alert('è¯·ç²˜è´´ HAR æ–‡ä»¶å†…å®¹æˆ–ç½‘ç»œè¯·æ±‚ä¿¡æ¯');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const extractBtn = event.target;
            const originalText = extractBtn.innerHTML;
            extractBtn.innerHTML = '<span class="loading-spinner"></span> æ­£åœ¨è§£æ...';
            extractBtn.disabled = true;

            try {
                const response = await fetch('/api/extract-cookies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: harContent })
                });

                const result = await response.json();
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                resultDiv.style.display = 'block';
                logsPre.textContent = result.logs || 'æ— æ—¥å¿—ä¿¡æ¯';

                if (result.success && result.data) {
                    extractedData = result.data;
                    
                    // æ˜¾ç¤ºæå–åˆ°çš„ Cookie
                    const cookies = result.data.cookies;
                    const missingCookies = result.data.missing_cookies || [];
                    
                    let cookiesHtml = '';
                    for (const [name, value] of Object.entries(cookies)) {
                        const isMissing = missingCookies.includes(name);
                        cookiesHtml += `
                            <div class="mb-1">
                                <span class="badge ${isMissing ? 'bg-warning' : 'bg-success'}">${name}</span>
                                <code class="ms-2">${value.substring(0, 30)}${value.length > 30 ? '...' : ''}</code>
                                ${isMissing ? '<small class="text-warning ms-2">(å¯èƒ½ç¼ºå¤±)</small>' : ''}
                            </div>
                        `;
                    }
                    
                    cookiesList.innerHTML = cookiesHtml || '<p class="text-muted">æœªæå–åˆ° Cookie</p>';
                    
                    // æ˜¾ç¤º Cookie åˆ—è¡¨å’Œæ·»åŠ æŒ‰é’®
                    cookiesSection.style.display = 'block';
                    
                    // è®¾ç½®é»˜è®¤è´¦å·å
                    const accountNameInput = document.getElementById('extractedAccountName');
                    if (!accountNameInput.value) {
                        accountNameInput.value = `è‡ªåŠ¨æå–_${new Date().toLocaleString()}`;
                    }
                } else {
                    extractedData = null;
                    cookiesSection.style.display = 'none';
                    
                    if (result.error) {
                        logsPre.textContent += '\n\nâŒ é”™è¯¯: ' + result.error;
                    }
                }
            } catch (error) {
                console.error('æå–å¤±è´¥:', error);
                resultDiv.style.display = 'block';
                logsPre.textContent = 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message;
                cookiesSection.style.display = 'none';
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                extractBtn.innerHTML = originalText;
                extractBtn.disabled = false;
            }
        }

        async function autoAddAccount() {
            if (!extractedData || !extractedData.cookies) {
                alert('è¯·å…ˆæå– Cookie');
                return;
            }

            const accountName = document.getElementById('extractedAccountName').value.trim();
            if (!accountName) {
                alert('è¯·è¾“å…¥è´¦å·å¤‡æ³¨å');
                return;
            }

            const addBtn = event.target;
            const originalText = addBtn.innerHTML;
            addBtn.innerHTML = '<span class="loading-spinner"></span> æ·»åŠ ä¸­...';
            addBtn.disabled = true;

            try {
                const response = await fetch('/api/auto-add-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: accountName,
                        cookies: extractedData.cookies
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('è´¦å·æ·»åŠ æˆåŠŸï¼');
                    // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°è´¦å·
                    window.location.reload();
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + (result.error || result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ è´¦å·å¤±è´¥:', error);
                alert('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                addBtn.innerHTML = originalText;
                addBtn.disabled = false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šåˆå§‹åŒ–ä»£ç 
        });
    </script>
</body>
</html>